# Docker Compose for Tourist Scheduling System
#
# This file is for building container images and local infrastructure only.
# For runtime, deploy to Kubernetes using the manifests in deploy/k8s/
#
# Usage:
#   docker-compose build                         # Build agent images
#   docker-compose up -d slim jaeger             # Start local infrastructure for dev
#   docker-compose down                          # Stop infrastructure
#
# Build and tag for registry:
#   docker-compose build
#   docker tag tourist_scheduling_system-scheduler $REGISTRY/scheduler-agent:$TAG
#   docker tag tourist_scheduling_system-ui $REGISTRY/ui-agent:$TAG
#
# For Kubernetes deployment, see deploy/k8s/README.md

version: '3.8'

services:
  # ==========================================================================
  # Build-only Agent Services (for creating images to push to registry)
  # ==========================================================================

  # Scheduler Agent - ADK-based coordinator (A2A server)
  scheduler:
    build:
      context: .
      dockerfile: containers/scheduler/Dockerfile
    image: scheduler-agent:latest
    ports:
      - "10000:10000"
    environment:
      - MODEL_PROVIDER=ollama
      - OLLAMA_MODEL=llama3.1:8b
      - OLLAMA_HOST=http://host.docker.internal:11434
      - TRANSPORT_MODE=http
      - LITELLM_LOG=DEBUG
      - SCHEDULER_EXTERNAL_URL=http://scheduler:10000
      - UI_DASHBOARD_URL=http://ui:10021/api/update
      - OTEL_EXPORTER_OTLP_ENDPOINT=http://jaeger:4318
      - ENABLE_TRACING=true
    extra_hosts:
      - "host.docker.internal:host-gateway"
    networks:
      - tourist-net

  # UI Dashboard Agent - Real-time monitoring dashboard (A2A server)
  ui:
    build:
      context: .
      dockerfile: containers/ui/Dockerfile
    image: ui-agent:latest
    ports:
      - "10021:10021"
    environment:
      - MODEL_PROVIDER=ollama
      - OLLAMA_MODEL=qwen3:14b
      - OLLAMA_HOST=http://host.docker.internal:11434
      - SCHEDULER_URL=http://scheduler:10000
    extra_hosts:
      - "host.docker.internal:host-gateway"
    depends_on:
      - scheduler
    networks:
      - tourist-net

  # Guide Agent - Client that offers tour services (Job)
  guide:
    build:
      context: .
      dockerfile: containers/guide/Dockerfile
    image: guide-agent:latest
    environment:
      - MODEL_PROVIDER=ollama
      - OLLAMA_MODEL=llama3.1:8b
      - OLLAMA_HOST=http://host.docker.internal:11434
      - SCHEDULER_URL=http://scheduler:10000
      - LITELLM_LOG=DEBUG
      - OTEL_EXPORTER_OTLP_ENDPOINT=http://jaeger:4318
      - ENABLE_TRACING=true
    extra_hosts:
      - "host.docker.internal:host-gateway"
    command: ["--guide-id", "g1", "--categories", "culture,history"]
    depends_on:
      - scheduler
    restart: on-failure
    networks:
      - tourist-net

  # Tourist Agent - Client that requests tours (Job)
  tourist:
    build:
      context: .
      dockerfile: containers/tourist/Dockerfile
    image: tourist-agent:latest
    environment:
      - MODEL_PROVIDER=ollama
      - OLLAMA_MODEL=llama3.1:8b
      - OLLAMA_HOST=http://host.docker.internal:11434
      - SCHEDULER_URL=http://scheduler:10000
      - OTEL_EXPORTER_OTLP_ENDPOINT=http://jaeger:4318
      - ENABLE_TRACING=true
    extra_hosts:
      - "host.docker.internal:host-gateway"
    command: ["--tourist-id", "t1", "--preferences", "culture,food"]
    depends_on:
      - scheduler
    restart: on-failure
    networks:
      - tourist-net

  # ==========================================================================
  # Local Infrastructure (for development/testing)
  # ==========================================================================

  # SLIM Data Plane Node
  slim:
    image: ghcr.io/agntcy/slim:latest
    container_name: slim-node
    ports:
      - "${SLIM_PORT:-46357}:46357"
    volumes:
      - ./slim-config.yaml:/config.yaml:ro
    command: ["/slim", "-c", "/config.yaml"]
    restart: unless-stopped
    networks:
      - tourist-net

  # SLIM with OpenTelemetry enabled
  slim-otel:
    image: ghcr.io/agntcy/slim:latest
    container_name: slim-node-otel
    ports:
      - "${SLIM_PORT:-46357}:46357"
    volumes:
      - ./slim-config-otel.yaml:/config.yaml:ro
    command: ["/slim", "-c", "/config.yaml"]
    restart: unless-stopped
    depends_on:
      - jaeger
    networks:
      - tourist-net
    profiles:
      - tracing

  # Jaeger All-in-One for distributed tracing
  jaeger:
    image: jaegertracing/all-in-one:latest
    container_name: jaeger-tracing
    ports:
      - "${JAEGER_UI_PORT:-16686}:16686"      # Jaeger UI
      - "${JAEGER_OTLP_GRPC_PORT:-4317}:4317" # OTLP gRPC
      - "${JAEGER_OTLP_HTTP_PORT:-4318}:4318" # OTLP HTTP
    environment:
      - COLLECTOR_OTLP_ENABLED=true
    restart: unless-stopped
    networks:
      - tourist-net

networks:
  tourist-net:
    driver: bridge
